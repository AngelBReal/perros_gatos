<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="dwag_in_me.jpg">
    <title>Perros y Gatos - Clasificador Divertido</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body {
        background-color: #f8f9fa;
      }
      
      #resultado {
        font-weight: bold;
        font-size: 2rem;
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: 10px;
      }

      .canvas-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .result-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
      }

      #image-result {
        max-width: 250px;
        margin-top: 10px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
      }

      #video {
        display: none;
      }
      
      .dog-style {
        background-color: #ffc107; /* Yellow */
        color: black;
      }
      
      .cat-style {
        background-color: #007bff; /* Blue */
        color: white;
      }
    </style>
  </head>

  <body>
    <main class="container text-center mt-4">
      <h1 class="fw-bold">üê∂ Perros y Gatos üê±</h1>
      <p class="lead">Clasificaci√≥n en tiempo real usando la c√°mara y TensorFlow.js</p>

      <div class="canvas-container">
        <canvas id="canvas" width="400" height="400" style="border: 2px solid #007bff; border-radius: 10px;"></canvas>
        <video id="video" autoplay playsinline></video>
        <button class="btn btn-primary mt-3" id="cambiar-camara" onclick="cambiarCamara();">Cambiar C√°mara</button>
      </div>

      <div class="result-container">
        <div id="resultado" class="dog-style">Esperando predicci√≥n...</div>
        <img id="image-result" src="dwag_in_me.jpg" alt="Resultado" style="display: none;">
      </div>
    </main>

    <!-- Bootstrap and TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>

    <script type="text/javascript">
      var canvas = document.getElementById("canvas");
      var video = document.getElementById("video");
      var ctx = canvas.getContext("2d");
      var resultadoDiv = document.getElementById("resultado");
      var imageResult = document.getElementById("image-result");
      var modelo = null;
      var size = 400;
      var currentStream = null;
      var facingMode = "user"; 

      (async () => {
          console.log("Cargando modelo...");
          modelo = await tf.loadLayersModel("model.json");
          console.log("Modelo cargado...");
          mostrarCamara();
      })();

      function mostrarCamara() {
          var opciones = { audio: false, video: { facingMode: facingMode, width: size, height: size } };

          if(navigator.mediaDevices.getUserMedia) {
              navigator.mediaDevices.getUserMedia(opciones)
                  .then(function(stream) {
                      currentStream = stream;
                      video.srcObject = currentStream;
                      procesarCamara();
                      predecir();
                  })
                  .catch(function(err) {
                      alert("No se pudo utilizar la c√°mara :(");
                      console.log(err);
                  });
          } else {
              alert("Tu navegador no soporta el uso de la c√°mara.");
          }
      }

      function cambiarCamara() {
          if (currentStream) {
              currentStream.getTracks().forEach(track => track.stop());
          }

          facingMode = facingMode === "user" ? "environment" : "user";

          mostrarCamara();
      }

      function predecir() {
          if (modelo !== null) {
              ctx.drawImage(video, 0, 0, size, size, 0, 0, size, size);

              var imgData = ctx.getImageData(0, 0, 400, 400);
              var arr = [];
              var arr150 = [];
              for (var p = 0; p < imgData.data.length; p += 4) {
                  var red = imgData.data[p] / 255;
                  var green = imgData.data[p + 1] / 255;
                  var blue = imgData.data[p + 2] / 255;
                  arr150.push([red, green, blue]);
                  if (arr150.length == 150) {
                      arr.push(arr150);
                      arr150 = [];
                  }
              }

              arr = [arr];
              var tensor4 = tf.tensor4d(arr);
              var resultados = modelo.predict(tensor4).dataSync();
              var mayorIndice = resultados.indexOf(Math.max.apply(null, resultados));

              var clases = ['Gato', 'Perro'];
              
              // Set result text and update image
              if (mayorIndice === 1) {
                  resultadoDiv.innerHTML = "Dawg in Me üê∂";
                  resultadoDiv.classList.remove("cat-style");
                  resultadoDiv.classList.add("dog-style");
                  imageResult.src = "dwag_in_me_result.jpg";
              } else {
                  resultadoDiv.innerHTML = "Not Dawg in Me üê±";
                  resultadoDiv.classList.remove("dog-style");
                  resultadoDiv.classList.add("cat-style");
                  imageResult.src = "cat_in_me_result.webp";
              }

              imageResult.style.display = "block";
          }

          setTimeout(predecir, 150);
      }

      function procesarCamara() {
          ctx.drawImage(video, 0, 0, size, size, 0, 0, size, size);
          setTimeout(procesarCamara, 20);
      }
    </script>
  </body>
</html>
